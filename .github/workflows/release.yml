name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'          # Stable: v1.0.0
      - 'v*.*.*-beta.*'   # Beta: v1.0.0-beta.1
      - 'v*.*.*-rc.*'     # Release Candidate: v1.0.0-rc.1
      - 'v*.*.*-alpha.*'  # Alpha: v1.0.0-alpha.1
      - 'v*.*.*-dev.*'    # Dev: v1.0.0-dev.1

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: |
        FULL_VERSION="${GITHUB_REF#refs/tags/v}"
        echo "VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT

        # Detect if this is a pre-release
        if [[ "$FULL_VERSION" =~ (beta|rc|alpha|dev) ]]; then
          echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
          echo "This is a pre-release version: $FULL_VERSION"
        else
          echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
          echo "This is a stable release: $FULL_VERSION"
        fi

    - name: Verify version matches plugin.json (stable only)
      if: steps.get_version.outputs.IS_PRERELEASE == 'false'
      run: |
        PLUGIN_VERSION=$(grep -o '"version": *"[^"]*"' plugin.json | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
        TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
        if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Version mismatch!"
          echo "plugin.json version: $PLUGIN_VERSION"
          echo "Git tag version: $TAG_VERSION"
          exit 1
        fi
        echo "Version check passed: $PLUGIN_VERSION"

    - name: Version info for pre-release
      if: steps.get_version.outputs.IS_PRERELEASE == 'true'
      run: |
        PLUGIN_VERSION=$(grep -o '"version": *"[^"]*"' plugin.json | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
        echo "Pre-release version: ${{ steps.get_version.outputs.VERSION }}"
        echo "Base plugin.json version: $PLUGIN_VERSION"
        echo "Note: Pre-releases don't require exact version match"

    - name: Create package structure
      run: |
        mkdir -p build/MySupportImprover/qt6

    - name: Copy plugin files
      run: |
        cp plugin.json build/MySupportImprover/
        cp __init__.py build/MySupportImprover/
        cp MySupportImprover.py build/MySupportImprover/
        cp presets.json build/MySupportImprover/
        cp down.svg build/MySupportImprover/
        cp qt6/SupportImprover.qml build/MySupportImprover/qt6/
        cp README.md build/MySupportImprover/
        cp CHANGELOG.md build/MySupportImprover/

    - name: Create release package
      run: |
        cd build
        zip -r MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip MySupportImprover/
        cd ..

    - name: Generate release notes from changelog
      id: changelog
      run: |
        # Extract the latest version's changes from CHANGELOG.md
        VERSION="${{ steps.get_version.outputs.VERSION }}"

        # Get content between the first [VERSION] heading and the next version heading
        NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)

        # If notes are empty, provide a default message
        if [ -z "$NOTES" ]; then
          NOTES="Release version $VERSION. See CHANGELOG.md for details."
        fi

        # Save to output (escape for GitHub Actions)
        echo "NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip
        body: ${{ steps.changelog.outputs.NOTES }}
        draft: false
        prerelease: ${{ steps.get_version.outputs.IS_PRERELEASE }}
        name: Release v${{ steps.get_version.outputs.VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact for verification
      uses: actions/upload-artifact@v3
      with:
        name: MySupportImprover-${{ steps.get_version.outputs.VERSION }}
        path: build/MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip
        retention-days: 90
