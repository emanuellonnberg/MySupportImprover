name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Verify version matches plugin.json
      run: |
        PLUGIN_VERSION=$(grep -o '"version": *"[^"]*"' plugin.json | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
        TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
        if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Version mismatch!"
          echo "plugin.json version: $PLUGIN_VERSION"
          echo "Git tag version: $TAG_VERSION"
          exit 1
        fi
        echo "Version check passed: $PLUGIN_VERSION"

    - name: Create package structure
      run: |
        mkdir -p build/MySupportImprover/qt6

    - name: Copy plugin files
      run: |
        cp plugin.json build/MySupportImprover/
        cp __init__.py build/MySupportImprover/
        cp MySupportImprover.py build/MySupportImprover/
        cp presets.json build/MySupportImprover/
        cp down.svg build/MySupportImprover/
        cp qt6/SupportImprover.qml build/MySupportImprover/qt6/
        cp README.md build/MySupportImprover/
        cp CHANGELOG.md build/MySupportImprover/

    - name: Create release package
      run: |
        cd build
        zip -r MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip MySupportImprover/
        cd ..

    - name: Generate release notes from changelog
      id: changelog
      run: |
        # Extract the latest version's changes from CHANGELOG.md
        VERSION="${{ steps.get_version.outputs.VERSION }}"

        # Get content between the first [VERSION] heading and the next version heading
        NOTES=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)

        # If notes are empty, provide a default message
        if [ -z "$NOTES" ]; then
          NOTES="Release version $VERSION. See CHANGELOG.md for details."
        fi

        # Save to output (escape for GitHub Actions)
        echo "NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip
        body: ${{ steps.changelog.outputs.NOTES }}
        draft: false
        prerelease: false
        name: Release v${{ steps.get_version.outputs.VERSION }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact for verification
      uses: actions/upload-artifact@v3
      with:
        name: MySupportImprover-${{ steps.get_version.outputs.VERSION }}
        path: build/MySupportImprover-${{ steps.get_version.outputs.VERSION }}.zip
        retention-days: 90
